{% extends "layout.html" %}
{% block title %}
    CernWall's predefined modes
{% endblock %}
{% block body %}
  <h2>{{ self.title() }}</h2>
  <ul class="messages">
  {% for message in messages %}
    <li>
        {% if message.error %}
            ERROR: mode ('m' parameter) is not defined {{ message.name }}
        {% else %}
        <button class="mode_btn" data-url="{{ message.url }}" data-id="id_{{ message.id }}">{{ message.name }}</button>
        <p class="statusfield" id="status_{{ message.id }}">-</p>
        <p class="urlfield">{{ message.url }}</p>
        {% endif %}
    </li>
  {% else %}
      <li><em>No modes, check cernwall_ui_config.py for details</em></li>
  {% endfor %}
  </ul>

    <script type="text/javascript">

var running = false;

$("button").on("click", function() {

    var msg;
    var btn = $(this);
    var t_out = 4000;
    var id = $(this).data("id");
    var url = $(this).data("url");
    console.log($(this).text());
    console.log(url);
    if (running == true) {
        btn.next().text("Previous call is still active");
        return;
    }
    $( ".statusfield" ).each(function( index ) {
        $( this ).text("-")
    });
    btn.next().text("Calling (timeout is " + t_out + " ms)");
    running = true;
    var jqxhr = $.ajax({
        url: url,
        timeout: t_out
    });
    jqxhr.done(function(d) {
        btn.next().text("OK: " + d.slice(0, 20));
    });

    jqxhr.fail(function(xmlhttprequest, textstatus, message) {
        if (textstatus==="timeout") {
            msg = "got timeout";
        } else {
            msg = textstatus;
        }
        btn.next().text("Failed: " + msg );
        console.log("ERR " + btn.text()) + ": " + msg;
    });

    jqxhr.always(function() {
        console.log("Finished");
        running = false;
    });
});


</script>

{% endblock %}
